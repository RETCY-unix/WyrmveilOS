#include "../../Lib/include/graphics.h"

// Framebuffer pointer (will be set by bootloader)
static unsigned int* framebuffer = 0;

// Simple 8x8 bitmap font
static unsigned char font_8x8[128][8] = {
    // Space (32)
    [32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ! (33)
    [33] = {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00},
    // " (34)
    [34] = {0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // # (35)
    [35] = {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00},
    // $ (36)
    [36] = {0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00},
    // A-Z (65-90)
    [65] = {0x18, 0x24, 0x24, 0x42, 0x7E, 0x42, 0x42, 0x00}, // A
    [66] = {0x3F, 0x42, 0x42, 0x3E, 0x42, 0x42, 0x3F, 0x00}, // B
    [67] = {0x3C, 0x42, 0x02, 0x02, 0x02, 0x42, 0x3C, 0x00}, // C
    [68] = {0x1F, 0x22, 0x42, 0x42, 0x42, 0x22, 0x1F, 0x00}, // D
    [69] = {0x7E, 0x02, 0x02, 0x3E, 0x02, 0x02, 0x7E, 0x00}, // E
    [70] = {0x7E, 0x02, 0x02, 0x3E, 0x02, 0x02, 0x02, 0x00}, // F
    [71] = {0x3C, 0x42, 0x02, 0x72, 0x42, 0x42, 0x3C, 0x00}, // G
    [72] = {0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00}, // H
    [73] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // I
    [74] = {0x78, 0x20, 0x20, 0x20, 0x20, 0x22, 0x1C, 0x00}, // J
    [75] = {0x42, 0x22, 0x12, 0x0E, 0x12, 0x22, 0x42, 0x00}, // K
    [76] = {0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x7E, 0x00}, // L
    [77] = {0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00}, // M
    [78] = {0x42, 0x46, 0x4A, 0x52, 0x62, 0x42, 0x42, 0x00}, // N
    [79] = {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00}, // O
    [80] = {0x3E, 0x42, 0x42, 0x3E, 0x02, 0x02, 0x02, 0x00}, // P
    [81] = {0x3C, 0x42, 0x42, 0x42, 0x52, 0x22, 0x5C, 0x00}, // Q
    [82] = {0x3E, 0x42, 0x42, 0x3E, 0x12, 0x22, 0x42, 0x00}, // R
    [83] = {0x3C, 0x42, 0x02, 0x3C, 0x40, 0x42, 0x3C, 0x00}, // S
    [84] = {0x7F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00}, // T
    [85] = {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00}, // U
    [86] = {0x42, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18, 0x00}, // V
    [87] = {0x42, 0x42, 0x42, 0x5A, 0x5A, 0x66, 0x42, 0x00}, // W
    [88] = {0x42, 0x24, 0x18, 0x18, 0x18, 0x24, 0x42, 0x00}, // X
    [89] = {0x41, 0x22, 0x14, 0x08, 0x08, 0x08, 0x08, 0x00}, // Y
    [90] = {0x7E, 0x40, 0x20, 0x10, 0x08, 0x04, 0x7E, 0x00}, // Z
    // a-z (97-122)
    [97] = {0x00, 0x00, 0x3C, 0x40, 0x7C, 0x42, 0x7C, 0x00}, // a
    [98] = {0x02, 0x02, 0x3E, 0x42, 0x42, 0x42, 0x3E, 0x00}, // b
    [99] = {0x00, 0x00, 0x3C, 0x42, 0x02, 0x42, 0x3C, 0x00}, // c
    [100] = {0x40, 0x40, 0x7C, 0x42, 0x42, 0x42, 0x7C, 0x00}, // d
    [101] = {0x00, 0x00, 0x3C, 0x42, 0x7E, 0x02, 0x3C, 0x00}, // e
    [102] = {0x30, 0x48, 0x08, 0x3E, 0x08, 0x08, 0x08, 0x00}, // f
    [103] = {0x00, 0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x3C}, // g
    [104] = {0x02, 0x02, 0x3E, 0x42, 0x42, 0x42, 0x42, 0x00}, // h
    [105] = {0x08, 0x00, 0x0C, 0x08, 0x08, 0x08, 0x3C, 0x00}, // i
    [106] = {0x10, 0x00, 0x18, 0x10, 0x10, 0x10, 0x12, 0x0C}, // j
    [107] = {0x02, 0x02, 0x22, 0x12, 0x0E, 0x12, 0x22, 0x00}, // k
    [108] = {0x0C, 0x08, 0x08, 0x08, 0x08, 0x08, 0x3C, 0x00}, // l
    [109] = {0x00, 0x00, 0x36, 0x49, 0x49, 0x49, 0x49, 0x00}, // m
    [110] = {0x00, 0x00, 0x3E, 0x42, 0x42, 0x42, 0x42, 0x00}, // n
    [111] = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00}, // o
    [112] = {0x00, 0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x02}, // p
    [113] = {0x00, 0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40}, // q
    [114] = {0x00, 0x00, 0x3A, 0x46, 0x02, 0x02, 0x02, 0x00}, // r
    [115] = {0x00, 0x00, 0x3C, 0x02, 0x3C, 0x40, 0x3E, 0x00}, // s
    [116] = {0x08, 0x08, 0x3E, 0x08, 0x08, 0x48, 0x30, 0x00}, // t
    [117] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x62, 0x5C, 0x00}, // u
    [118] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00}, // v
    [119] = {0x00, 0x00, 0x49, 0x49, 0x49, 0x49, 0x36, 0x00}, // w
    [120] = {0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00}, // x
    [121] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x7C, 0x40, 0x3C}, // y
    [122] = {0x00, 0x00, 0x7E, 0x20, 0x10, 0x08, 0x7E, 0x00}, // z
    // Numbers (48-57)
    [48] = {0x3C, 0x46, 0x4A, 0x52, 0x62, 0x42, 0x3C, 0x00}, // 0
    [49] = {0x18, 0x1C, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00}, // 1
    [50] = {0x3C, 0x42, 0x40, 0x3C, 0x02, 0x42, 0x7E, 0x00}, // 2
    [51] = {0x3C, 0x42, 0x40, 0x3C, 0x40, 0x42, 0x3C, 0x00}, // 3
    [52] = {0x20, 0x30, 0x28, 0x24, 0x7E, 0x20, 0x20, 0x00}, // 4
    [53] = {0x7E, 0x02, 0x3E, 0x40, 0x40, 0x42, 0x3C, 0x00}, // 5
    [54] = {0x3C, 0x02, 0x3E, 0x42, 0x42, 0x42, 0x3C, 0x00}, // 6
    [55] = {0x7E, 0x40, 0x20, 0x10, 0x08, 0x08, 0x08, 0x00}, // 7
    [56] = {0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00}, // 8
    [57] = {0x3C, 0x42, 0x42, 0x7C, 0x40, 0x42, 0x3C, 0x00}, // 9
    // Special characters
    [45] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00}, // - (minus/hyphen)
    [46] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00}, // . (period)
    [47] = {0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00}, // / (slash)
    [58] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00}, // : (colon)
    [59] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x08}, // ; (semicolon)
    [61] = {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00}, // = (equals)
    [63] = {0x3C, 0x42, 0x40, 0x20, 0x10, 0x00, 0x10, 0x00}, // ? (question)
    [64] = {0x3C, 0x42, 0x5A, 0x56, 0x5A, 0x02, 0x3C, 0x00}, // @ (at)
    [40] = {0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20, 0x00}, // ( (left paren)
    [41] = {0x04, 0x08, 0x10, 0x10, 0x10, 0x08, 0x04, 0x00}, // ) (right paren)
    [42] = {0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00, 0x00}, // * (asterisk)
    [43] = {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00}, // + (plus)
    [44] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x08}, // , (comma)
    [91] = {0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00}, // [ (left bracket)
    [93] = {0x1C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1C, 0x00}, // ] (right bracket)
    [95] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00}, // _ (underscore)
};

// Initialize graphics
void graphics_init() {
    // Get framebuffer address from bootloader (stored at 0x5000)
    framebuffer = (unsigned int*)(*((unsigned int*)0x5000));
    
    // Clear screen to black
    graphics_clear(COLOR_BLACK);
}

// Get framebuffer pointer
unsigned int* graphics_get_framebuffer() {
    return framebuffer;
}

// Clear screen with color
void graphics_clear(color_t color) {
    unsigned int color_val = (color.a << 24) | (color.r << 16) | (color.g << 8) | color.b;
    for (int i = 0; i < SCREEN_WIDTH * SCREEN_HEIGHT; i++) {
        framebuffer[i] = color_val;
    }
}

// Put pixel at x, y
void graphics_putpixel(int x, int y, color_t color) {
    if (x < 0 || x >= SCREEN_WIDTH || y < 0 || y >= SCREEN_HEIGHT) {
        return;
    }
    
    int offset = y * SCREEN_WIDTH + x;
    unsigned int color_val = (color.a << 24) | (color.r << 16) | (color.g << 8) | color.b;
    framebuffer[offset] = color_val;
}

// Get pixel at x, y
color_t graphics_getpixel(int x, int y) {
    if (x < 0 || x >= SCREEN_WIDTH || y < 0 || y >= SCREEN_HEIGHT) {
        return COLOR_BLACK;
    }
    
    int offset = y * SCREEN_WIDTH + x;
    unsigned int pixel = framebuffer[offset];
    
    color_t color;
    color.b = pixel & 0xFF;
    color.g = (pixel >> 8) & 0xFF;
    color.r = (pixel >> 16) & 0xFF;
    color.a = (pixel >> 24) & 0xFF;
    
    return color;
}

// Fill rectangle
void graphics_fill_rect(int x, int y, int width, int height, color_t color) {
    for (int dy = 0; dy < height; dy++) {
        for (int dx = 0; dx < width; dx++) {
            graphics_putpixel(x + dx, y + dy, color);
        }
    }
}

// Draw rectangle outline
void graphics_draw_rect(int x, int y, int width, int height, color_t color) {
    // Top and bottom
    for (int dx = 0; dx < width; dx++) {
        graphics_putpixel(x + dx, y, color);
        graphics_putpixel(x + dx, y + height - 1, color);
    }
    
    // Left and right
    for (int dy = 0; dy < height; dy++) {
        graphics_putpixel(x, y + dy, color);
        graphics_putpixel(x + width - 1, y + dy, color);
    }
}

// Draw line (Bresenham's algorithm)
void graphics_draw_line(int x1, int y1, int x2, int y2, color_t color) {
    int dx = x2 - x1;
    int dy = y2 - y1;
    int dx_abs = dx < 0 ? -dx : dx;
    int dy_abs = dy < 0 ? -dy : dy;
    int sx = dx < 0 ? -1 : 1;
    int sy = dy < 0 ? -1 : 1;
    
    if (dx_abs > dy_abs) {
        int err = dx_abs / 2;
        int y = y1;
        for (int x = x1; x != x2; x += sx) {
            graphics_putpixel(x, y, color);
            err -= dy_abs;
            if (err < 0) {
                y += sy;
                err += dx_abs;
            }
        }
    } else {
        int err = dy_abs / 2;
        int x = x1;
        for (int y = y1; y != y2; y += sy) {
            graphics_putpixel(x, y, color);
            err -= dx_abs;
            if (err < 0) {
                x += sx;
                err += dy_abs;
            }
        }
    }
}

// Alpha blending function
color_t graphics_blend(color_t fg, color_t bg) {
    if (fg.a == 255) return fg;
    if (fg.a == 0) return bg;
    
    color_t result;
    int alpha = fg.a;
    int inv_alpha = 255 - alpha;
    
    result.r = (fg.r * alpha + bg.r * inv_alpha) / 255;
    result.g = (fg.g * alpha + bg.g * inv_alpha) / 255;
    result.b = (fg.b * alpha + bg.b * inv_alpha) / 255;
    result.a = 255;
    
    return result;
}

// Draw a character at x, y using bitmap font
void graphics_draw_char(int x, int y, char c, color_t fg, color_t bg) {
    if (c < 0 || c >= 128) c = '?';
    
    for (int row = 0; row < 8; row++) {
        unsigned char line = font_8x8[(int)c][row];
        for (int col = 0; col < 8; col++) {
            if (line & (1 << (7 - col))) {
                // Draw foreground
                if (bg.a > 0) {
                    color_t blended = graphics_blend(fg, graphics_getpixel(x + col, y + row));
                    graphics_putpixel(x + col, y + row, blended);
                } else {
                    graphics_putpixel(x + col, y + row, fg);
                }
            } else if (bg.a == 255) {
                // Draw background (only if opaque)
                graphics_putpixel(x + col, y + row, bg);
            }
        }
    }
}

// Draw a string at x, y
void graphics_draw_string(int x, int y, const char* str, color_t fg, color_t bg) {
    int current_x = x;
    int i = 0;
    
    while (str[i] != '\0') {
        if (str[i] == '\n') {
            current_x = x;
            y += 10;
        } else {
            graphics_draw_char(current_x, y, str[i], fg, bg);
            current_x += 8;
        }
        i++;
    }
}

// Simple gradient wallpaper generator
void graphics_load_wallpaper() {
    // Create a beautiful gradient wallpaper
    for (int y = 0; y < SCREEN_HEIGHT; y++) {
        for (int x = 0; x < SCREEN_WIDTH; x++) {
            // Create a gradient from dark blue/purple to lighter blue
            unsigned char r = (y * 100) / SCREEN_HEIGHT + 20;
            unsigned char g = (y * 150) / SCREEN_HEIGHT + 30;
            unsigned char b = 100 + (y * 155) / SCREEN_HEIGHT;
            
            // Add some variation based on x position
            r += (x * 20) / SCREEN_WIDTH;
            g += (x * 30) / SCREEN_WIDTH;
            
            color_t color = {b, g, r, 255};
            graphics_putpixel(x, y, color);
        }
    }
    
    // Draw some decorative circles for effect
    for (int i = 0; i < 5; i++) {
        int cx = (i * 256 + 128) % SCREEN_WIDTH;
        int cy = (i * 192 + 100) % SCREEN_HEIGHT;
        int radius = 80 + (i * 30);
        
        color_t circle_color = {150, 100, 200, 40}; // Semi-transparent purple
        
        for (int y = -radius; y <= radius; y++) {
            for (int x = -radius; x <= radius; x++) {
                if (x*x + y*y <= radius*radius) {
                    int px = cx + x;
                    int py = cy + y;
                    if (px >= 0 && px < SCREEN_WIDTH && py >= 0 && py < SCREEN_HEIGHT) {
                        color_t bg = graphics_getpixel(px, py);
                        color_t blended = graphics_blend(circle_color, bg);
                        graphics_putpixel(px, py, blended);
                    }
                }
            }
        }
    }
}
